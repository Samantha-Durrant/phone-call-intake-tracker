<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Screenpop Analytics</title>
    <meta name="color-scheme" content="light dark" />
    <style>
      :root{ --line:#e5e7eb; --muted:#6b7280; --brand:#4f46e5; }
      *{ box-sizing:border-box }
      html,body{ height:100% }
      body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#f5f7fb; color:#111827; }
      header{ display:flex; align-items:center; justify-content:space-between; padding:10px 14px; background:linear-gradient(180deg,#f9fafb,#f3f4f6); border-bottom:1px solid var(--line) }
      .wrap{ display:grid; grid-template-columns:minmax(360px, 560px) 1fr; gap:12px; padding:12px; height:calc(100% - 56px) }
      .panel{ background:#fff; border:1px solid var(--line); border-radius:12px; overflow:hidden; display:flex; flex-direction:column }
      .panel h2{ margin:0; padding:10px 12px; font-size:14px; border-bottom:1px solid var(--line); background:#f9fafb }
      .panel .body{ flex:1; overflow:auto }
      iframe{ width:100%; height:100%; border:0; display:block }
      .toolbar{ display:flex; gap:8px; align-items:center; padding:8px 12px; border-bottom:1px solid var(--line); background:#fff; flex-wrap:wrap }
      button{ height:32px; padding:0 10px; border-radius:8px; border:1px solid var(--line); background:#fff; cursor:pointer; font-weight:600 }
      button.primary{ background:var(--brand); border-color:var(--brand); color:#fff }
      .tab-toggle{ display:inline-flex; border:1px solid var(--line); border-radius:8px; overflow:hidden; background:#fff }
      .tab-toggle button{ border:none; border-right:1px solid var(--line); background:transparent; padding:6px 12px; font-weight:600; cursor:pointer; color:#111827 }
      .tab-toggle button:last-child{ border-right:none }
      .tab-toggle button.active{ background:#eef2ff; color:#1f2937 }
      table{ width:100%; border-collapse:collapse; font-size:13px }
      .chart-with-legend{ display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap }
      .chart-with-legend canvas{ flex:1 1 260px }
      .chart-legend{ display:flex; flex-direction:column; gap:8px; min-width:160px; font-size:12px }
      .chart-legend .legend-item{ display:flex; align-items:center; gap:8px; cursor:default }
      .chart-legend .legend-item:hover{ opacity:.8 }
      .panel.allow-overflow{ overflow:visible }
      .panel.allow-overflow .body{ overflow:visible }
      .chart-legend .legend-item.has-details{ position:relative; align-items:flex-start; opacity:1 }
      .chart-legend .legend-item.has-details .legend-detail-hint{ color:var(--muted); font-size:11px }
      .chart-legend .legend-item.has-details[data-open] .legend-detail-hint{ color:var(--brand); font-weight:600 }
      .chart-legend .legend-item.has-details .legend-details{ display:none; position:absolute; left:calc(100% + 10px); top:-4px; background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px 12px; box-shadow:0 10px 25px rgba(15,23,42,0.12); width:220px; max-width:260px; z-index:20 }
      .chart-legend .legend-item.has-details .legend-details-title{ font-weight:600; margin-bottom:6px; font-size:12px }
      .chart-legend .legend-item.has-details .legend-details-list{ margin:0; padding-left:18px; list-style:disc; display:flex; flex-direction:column; gap:4px; font-size:12px }
      .chart-legend .legend-item.has-details:hover .legend-details,
      .chart-legend .legend-item.has-details[data-open] .legend-details{ display:block }
      .chart-legend .swatch{ width:12px; height:12px; border-radius:3px }
      canvas.chart{ width:100%; height:180px; display:block }
      th, td{ text-align:left; padding:8px; border-bottom:1px solid var(--line); vertical-align:top }
      th{ position:sticky; top:0; background:#f9fafb; z-index:1 }
      .muted{ color:var(--muted) }
      .empty{ padding:16px; color:var(--muted) }
      /* Dashboard adjustments */
      .kpi-grid{ display:grid; grid-template-columns: repeat(2,minmax(140px,1fr)); gap:8px; padding:8px; border-bottom:1px solid var(--line); background:#fff }
      .kpi{ background:#f9fafb; border:1px solid var(--line); border-radius:10px; padding:8px 10px }
      .kpi .label{ color:var(--muted); font-size:12px }
      .kpi .value{ font-weight:700; font-size:18px }
      .charts{ display:grid; grid-template-columns: repeat(auto-fit, minmax(420px, 1fr)); gap:16px; align-items:stretch }
      .panel.wide{ grid-column: 1 / -1 }
      .panel .body{ padding:8px }
      .panel.table-panel .body{ padding:0; overflow:auto }
      .panel.table-panel table{ min-width:860px }
      .appt-lists{ display:flex; gap:24px; flex-wrap:wrap }
      .appt-column{ flex:1 1 320px; min-width:280px; display:flex; flex-direction:column; gap:12px }
      .appt-column h3{ margin:0; font-size:15px }
      .appt-list{ list-style:none; padding:0; margin:0; border:1px solid var(--line); border-radius:12px; background:#fff; max-height:360px; overflow:auto }
      .appt-list li{ display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border-bottom:1px solid var(--line); font-size:13px }
      .appt-meta{ display:flex; align-items:center; gap:8px; white-space:nowrap }
      .appt-percent{ color:var(--muted); font-size:12px }
      .appt-list li:last-child{ border-bottom:none }
      .appt-label{ flex:1; padding-right:12px }
      .appt-count{ font-weight:600 }
      .appt-empty{ padding:12px; color:var(--muted); font-style:italic }
      table thead th:nth-child(6), table tbody td:nth-child(6){ min-width:160px }
      tbody tr:nth-child(even){ background:#f9fafb }
      @media (min-width: 1024px){ .kpi-grid{ grid-template-columns: repeat(6,minmax(140px,1fr)); } }
      @media (max-width: 980px){ .wrap{ grid-template-columns: 1fr; height:auto } }
    </style>
  </head>
  <body>
    <header>
      <strong>Screenpop Analytics</strong>
      <div class="muted">Updates on “Done” from any screenpop tab</div>
    </header>
    <div class="wrap" style="grid-template-columns: 1fr; gap:12px;">
      <div class="panel" style="padding-bottom:0">
        <div class="toolbar" style="justify-content:space-between">
          <div style="display:flex;gap:6px;flex-wrap:wrap">
            <button id="exportCsvBtn">Export CSV</button>
            <button id="clearBtn">Clear</button>
            <input id="mrnSearch" type="text" placeholder="Search MRN" style="height:32px;padding:0 10px;border:1px solid var(--line);border-radius:8px" />
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            <div role="tablist" aria-label="Range" class="tab-toggle">
            <button id="tabDaily" role="tab" data-view="daily" aria-selected="true" class="active" type="button">Daily</button>
            <button id="tabMonthly" role="tab" data-view="monthly" aria-selected="false" type="button">Monthly</button>
          </div>
          <span id="dailyDateLabel" class="muted"></span>
          <input id="monthPicker" type="month" style="display:none;height:32px;padding:0 8px;border:1px solid var(--line);border-radius:8px" />
          <div style="display:flex;align-items:center;gap:6px">
            <span class="muted" id="officeFilterLabel">Office:</span>
            <div id="officeFilter" class="tab-toggle" role="tablist" aria-label="Office">
              <button type="button" class="active" data-office="all" role="tab" aria-selected="true">All Offices</button>
              <button type="button" data-office="Ann Arbor" role="tab" aria-selected="false">Ann Arbor</button>
              <button type="button" data-office="Plymouth" role="tab" aria-selected="false">Plymouth</button>
              <button type="button" data-office="Wixom" role="tab" aria-selected="false">Wixom</button>
            </div>
          </div>
          <button id="rolloverNow" title="TEST ONLY — roll daily into monthly" style="display:none;height:32px;padding:0 10px;border-radius:8px;border:1px solid var(--line);background:#fff;cursor:pointer">Rollover Now</button>
          <div class="muted" id="countBadge"></div>
        </div>
      </div>
        <div class="kpi-grid">
          <div class="kpi"><div class="label">Total Calls</div><div class="value" id="kpiTotal">0</div></div>
          <div class="kpi"><div class="label">Cancellations</div><div class="value" id="kpiCancel">0</div></div>
          <div class="kpi"><div class="label">Reschedules</div><div class="value" id="kpiResched">0</div></div>
          <div class="kpi"><div class="label">New</div><div class="value" id="kpiNew">0</div></div>
          <div class="kpi"><div class="label">Existing</div><div class="value" id="kpiExisting">0</div></div>
          <div class="kpi"><div class="label">Tasks / Transfers</div><div class="value" id="kpiActions">0 / 0</div></div>
        </div>
      </div>
      <div class="charts">
        <div class="panel wide"><h2>Time Distribution (8am–5pm)</h2><div class="body"><canvas id="chartHours" class="chart"></canvas></div></div>
        <div class="panel wide" id="panelWeekdays"><h2>Weekday Distribution (Mon–Fri)</h2><div class="body"><canvas id="chartWeekdays" class="chart"></canvas></div></div>
        <div class="panel allow-overflow"><h2>Scheduling by Office</h2><div class="body chart-with-legend"><canvas id="chartNewExisting" class="chart"></canvas><div id="chartNewExistingLegend" class="chart-legend"></div></div></div>
        <div class="panel"><h2>Confirmation Status</h2><div class="body"><canvas id="chartConfirmations" class="chart"></canvas></div></div>
        <div class="panel allow-overflow"><h2>Medical Appointment Mix</h2><div class="body chart-with-legend"><canvas id="chartApptMedical" class="chart"></canvas><div id="chartApptMedicalLegend" class="chart-legend"></div></div></div>
        <div class="panel allow-overflow"><h2>Cosmetic Appointment Mix</h2><div class="body chart-with-legend"><canvas id="chartApptCosmetic" class="chart"></canvas><div id="chartApptCosmeticLegend" class="chart-legend"></div></div></div>
        <div class="panel"><h2>Office Mix</h2><div class="body"><canvas id="chartOffices" class="chart"></canvas></div></div>
        <div class="panel"><h2>Cancel Reasons</h2><div class="body"><canvas id="chartCancelReasons" class="chart"></canvas></div></div>
        <div class="panel"><h2>Reschedule Reasons</h2><div class="body"><canvas id="chartReschedReasons" class="chart"></canvas></div></div>
        <div class="panel"><h2>Tasks by Type</h2><div class="body"><canvas id="chartTasksByType" class="chart"></canvas></div></div>
        <div class="panel"><h2>Transfers by Type</h2><div class="body"><canvas id="chartTransfersByType" class="chart"></canvas></div></div>
      </div>

      <div class="panel wide">
        <h2>Appointment Types</h2>
        <div class="body appt-lists">
          <div class="appt-column">
            <h3>Medical</h3>
            <ol id="listApptMedical" class="appt-list">
              <li class="appt-empty">No medical appointments yet</li>
            </ol>
          </div>
          <div class="appt-column">
            <h3>Cosmetic</h3>
            <ol id="listApptCosmetic" class="appt-list">
              <li class="appt-empty">No cosmetic appointments yet</li>
            </ol>
          </div>
        </div>
      </div>

      <div class="panel table-panel">
        <h2>Submissions</h2>
        <div class="body">
          <table id="analyticsTable" aria-label="Screenpop submissions">
            <thead>
              <tr>
                <th>Time</th>
                <th>MRN</th>
                <th>Type</th>
                <th>Scheduled</th>
                <th>Change</th>
                <th>Appt Type</th>
                <th>Office</th>
                <th>Reason</th>
                <th>Confirmed</th>
                <th>Other</th>
                <th>Tasks</th>
                <th>Transfers</th>
              </tr>
            </thead>
            <tbody id="analyticsBody">
              <tr class="empty"><td colspan="12">No submissions yet</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script src="./analytics.js" type="module"></script>
  </body>
  </html>
